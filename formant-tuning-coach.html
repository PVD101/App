<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Formant Tuning Coach</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg:      #080c14;
            --surface: #0f1624;
            --card:    #151e30;
            --border:  #1e2d47;
            --accent:  #00d4ff;
            --accent2: #7c3aed;
            --green:   #00e896;
            --yellow:  #ffd600;
            --red:     #ff3d71;
            --text:    #e8f0fe;
            --muted:   #6b7fa3;
            --font:    'Outfit', sans-serif;
            --mono:    'JetBrains Mono', monospace;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font);
            background: var(--bg);
            min-height: 100vh;
            color: var(--text);
            -webkit-overflow-scrolling: touch;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background-image:
                linear-gradient(rgba(0,212,255,0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0,212,255,0.03) 1px, transparent 1px);
            background-size: 40px 40px;
            pointer-events: none;
            z-index: 0;
        }

        .wrap {
            position: relative;
            z-index: 1;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px 16px 40px;
        }

        header {
            text-align: center;
            margin-bottom: 20px;
            padding: 28px 20px 22px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 24px;
            position: relative;
            overflow: hidden;
        }

        header::after {
            content: '';
            position: absolute;
            top: -40px; left: 50%;
            transform: translateX(-50%);
            width: 300px; height: 100px;
            background: radial-gradient(ellipse, rgba(0,212,255,0.15), transparent 70%);
            pointer-events: none;
        }

        header h1 {
            font-size: clamp(1.5em, 5vw, 2.2em);
            font-weight: 900;
            letter-spacing: -1px;
            background: linear-gradient(135deg, var(--accent), var(--accent2));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 6px;
        }

        header p { color: var(--muted); font-size: 0.88em; }

        .live-dot {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(255,61,113,0.15);
            border: 1px solid rgba(255,61,113,0.4);
            color: var(--red);
            padding: 5px 14px;
            border-radius: 20px;
            font-size: 0.75em;
            font-weight: 700;
            letter-spacing: 2px;
            text-transform: uppercase;
            margin-top: 10px;
        }
        .live-dot::before {
            content: '';
            width: 7px; height: 7px;
            background: var(--red);
            border-radius: 50%;
            animation: blink 1.2s infinite;
        }
        @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.2} }

        /* VOICE TYPE BADGE */
        .voice-badge {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background: rgba(0,212,255,0.08);
            border: 1px solid rgba(0,212,255,0.25);
            border-radius: 12px;
            padding: 10px 16px;
            margin-bottom: 16px;
            font-size: 0.88em;
            color: var(--accent);
            font-weight: 600;
        }

        .secure-badge {
            display: none;
            background: rgba(0,232,150,0.1);
            border: 1px solid rgba(0,232,150,0.3);
            color: var(--green);
            padding: 10px 16px;
            border-radius: 12px;
            margin-bottom: 16px;
            text-align: center;
            font-weight: 600;
            font-size: 0.85em;
        }
        .secure-badge.visible { display: block; }

        .setup-notice {
            background: rgba(0,212,255,0.07);
            border: 1px solid rgba(0,212,255,0.25);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            display: none;
        }
        .setup-notice.visible { display: block; }
        .setup-notice h3 { color: var(--accent); font-size: 1em; margin-bottom: 10px; }
        .setup-notice p  { color: var(--muted); font-size: 0.88em; line-height: 1.6; margin-bottom: 8px; }
        .setup-notice ol { margin-left: 18px; color: var(--text); font-size: 0.88em; line-height: 1.8; }
        .netlify-btn {
            display: block;
            background: linear-gradient(135deg, #00ad9f, #00796b);
            color: white;
            text-align: center;
            padding: 12px;
            border-radius: 10px;
            font-weight: 700;
            text-decoration: none;
            margin-top: 12px;
            font-size: 0.9em;
            touch-action: manipulation;
        }
        .dismiss-btn {
            display: block;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--muted);
            padding: 9px;
            border-radius: 10px;
            font-size: 0.85em;
            margin-top: 8px;
            width: 100%;
            cursor: pointer;
            touch-action: manipulation;
        }

        /* CONTROLS */
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .btn {
            padding: 16px 32px;
            font-family: var(--font);
            font-size: 1em;
            font-weight: 700;
            border: none;
            border-radius: 14px;
            cursor: pointer;
            letter-spacing: 1px;
            text-transform: uppercase;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            transition: opacity 0.2s, transform 0.1s;
            min-height: 54px;
        }
        .btn:active { opacity: 0.75; transform: scale(0.97); }
        .btn:disabled { opacity: 0.35; cursor: not-allowed; }
        #startBtn { background: linear-gradient(135deg, var(--accent), var(--accent2)); color: white; }
        #stopBtn  { background: var(--red); color: white; display: none; }

        /* SOUND SELECTOR */
        .selector-section {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .selector-section h2 {
            font-size: 0.72em;
            font-weight: 700;
            letter-spacing: 3px;
            text-transform: uppercase;
            color: var(--accent);
            margin-bottom: 14px;
        }

        .tab-row {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .tab {
            flex: 1;
            padding: 13px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--muted);
            font-family: var(--font);
            font-weight: 700;
            font-size: 0.9em;
            cursor: pointer;
            text-align: center;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            transition: all 0.2s;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .tab.active {
            background: linear-gradient(135deg, rgba(0,212,255,0.2), rgba(124,58,237,0.2));
            border-color: var(--accent);
            color: var(--accent);
        }

        /* BIGGER SOUND BUTTONS */
        .sound-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        @media (min-width: 500px) {
            .sound-grid { grid-template-columns: repeat(5, 1fr); }
        }

        .sound-btn {
            background: var(--card);
            border: 2px solid var(--border);
            border-radius: 14px;
            padding: 14px 8px;
            text-align: center;
            cursor: pointer;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            transition: all 0.2s;
            min-height: 70px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        .sound-btn:active { transform: scale(0.92); }
        .sound-btn.selected {
            background: linear-gradient(135deg, rgba(0,212,255,0.2), rgba(124,58,237,0.2));
            border-color: var(--accent);
        }

        .sound-symbol {
            font-size: 1.3em;
            font-weight: 900;
            color: var(--text);
            line-height: 1;
        }
        .sound-btn.selected .sound-symbol { color: var(--accent); }

        .sound-example {
            font-size: 0.62em;
            color: var(--muted);
        }
        .sound-btn.selected .sound-example { color: var(--accent); opacity: 0.8; }

        /* COACHING */
        .coaching-panel {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .current-sound {
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 12px 16px;
            margin-bottom: 14px;
        }
        .current-sound-symbol {
            font-size: 2.2em;
            font-weight: 900;
            color: var(--accent);
            min-width: 60px;
            text-align: center;
        }
        .current-sound-name { font-weight: 700; color: var(--text); font-size: 1em; }
        .current-sound-type { color: var(--muted); font-size: 0.78em; margin-top: 2px; }

        .coach-status {
            text-align: center;
            font-size: clamp(0.9em, 3vw, 1.15em);
            padding: 16px;
            background: var(--card);
            border-radius: 12px;
            margin-bottom: 16px;
            line-height: 1.4;
            font-weight: 600;
            border: 1px solid var(--border);
        }
        .coach-status.waiting   { color: var(--muted); }
        .coach-status.analyzing { color: var(--yellow); animation: pulse 1.5s infinite; }
        .coach-status.coaching  { color: var(--green); }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.6} }

        .adjustment-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
        }
        @media (min-width: 600px) {
            .adjustment-grid { grid-template-columns: repeat(3, 1fr); }
        }

        .adjustment-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 16px;
            transition: all 0.3s;
        }
        .adjustment-card.active {
            border-color: var(--green);
            background: rgba(0,232,150,0.07);
            box-shadow: 0 0 20px rgba(0,232,150,0.1);
        }
        .adjustment-card.warning {
            border-color: var(--red);
            background: rgba(255,61,113,0.07);
            box-shadow: 0 0 20px rgba(255,61,113,0.1);
        }
        .adjustment-card.caution {
            border-color: var(--yellow);
            background: rgba(255,214,0,0.05);
        }

        .adjustment-title {
            font-size: 1em;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--accent);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .adjustment-icon { font-size: 1.5em; }

        .adjustment-instruction {
            font-size: 0.88em;
            line-height: 1.55;
            color: var(--text);
            opacity: 0.9;
        }

        .adjustment-status {
            margin-top: 10px;
            padding: 8px 10px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            font-weight: 700;
            font-size: 0.8em;
            font-family: var(--mono);
        }
        .status-good       { color: var(--green); }
        .status-needs-work { color: var(--yellow); }
        .status-critical   { color: var(--red); }

        /* SMOOTHING INDICATOR */
        .smoothing-bar {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 10px 14px;
            margin-bottom: 16px;
            font-size: 0.8em;
            color: var(--muted);
        }
        .smoothing-dots {
            display: flex;
            gap: 4px;
        }
        .dot {
            width: 8px; height: 8px;
            border-radius: 50%;
            background: var(--border);
            transition: background 0.3s;
        }
        .dot.filled { background: var(--accent); }

        /* TARGET */
        .target-display {
            background: var(--surface);
            border: 1px solid rgba(255,214,0,0.3);
            padding: 16px;
            border-radius: 16px;
            margin-bottom: 20px;
            text-align: center;
        }
        .target-display h3 {
            color: var(--yellow);
            font-size: 0.72em;
            letter-spacing: 3px;
            text-transform: uppercase;
            margin-bottom: 12px;
        }
        .target-formants-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }
        .target-formant {
            background: var(--card);
            border: 1px solid rgba(255,214,0,0.25);
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 0.82em;
            font-weight: 700;
            color: var(--yellow);
            font-family: var(--mono);
        }
        .target-formant.in-range {
            border-color: var(--green);
            color: var(--green);
            background: rgba(0,232,150,0.07);
        }

        /* PROGRESS */
        .progress-section {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        .progress-card {
            background: var(--surface);
            border: 1px solid var(--border);
            padding: 14px 10px;
            border-radius: 16px;
            text-align: center;
        }
        .progress-label {
            color: var(--muted);
            font-weight: 600;
            font-size: clamp(0.62em, 2vw, 0.75em);
            letter-spacing: 1px;
            text-transform: uppercase;
            margin-bottom: 6px;
        }
        .progress-value {
            font-size: clamp(1.2em, 4vw, 1.8em);
            font-weight: 900;
            color: var(--text);
            font-family: var(--mono);
        }
        .progress-bar-container {
            background: var(--card);
            height: 6px;
            border-radius: 3px;
            margin-top: 8px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--green));
            border-radius: 3px;
            transition: width 0.6s ease;
        }

        /* SPECTROGRAM */
        .canvas-wrap {
            background: #000;
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 12px;
            margin-bottom: 20px;
        }
        .canvas-label {
            font-size: 0.68em;
            color: var(--muted);
            letter-spacing: 2px;
            text-transform: uppercase;
            margin-bottom: 8px;
        }
        canvas { display: block; width: 100%; height: auto; border-radius: 8px; }

        /* TIPS */
        .tips {
            background: var(--surface);
            border: 1px solid rgba(0,232,150,0.2);
            padding: 16px;
            border-radius: 16px;
        }
        .tips h3 {
            color: var(--green);
            margin-bottom: 12px;
            font-size: 0.72em;
            letter-spacing: 3px;
            text-transform: uppercase;
        }
        .tip-item {
            padding: 10px 14px;
            margin: 6px 0;
            background: var(--card);
            border-left: 3px solid var(--green);
            border-radius: 0 8px 8px 0;
            font-size: 0.87em;
            line-height: 1.4;
            color: var(--text);
            opacity: 0.85;
        }
    </style>
</head>
<body>
<div class="wrap">

    <header>
        <h1>üéØ Formant Tuning Coach</h1>
        <p>Real-time vowel &amp; consonant articulation guidance</p>
        <div class="live-dot">Live Coaching</div>
    </header>

    <div class="setup-notice" id="setupNotice">
        <h3>üì± Hosting required for iPhone Safari mic access</h3>
        <p>Safari on iPhone requires HTTPS. Upload to Netlify Drop ‚Äî free, 60 seconds:</p>
        <ol>
            <li>On a computer go to <strong>app.netlify.com/drop</strong></li>
            <li>Drag this HTML file onto the page</li>
            <li>Copy the URL and open in Safari on iPhone</li>
            <li>Tap Allow for microphone</li>
        </ol>
        <a class="netlify-btn" href="https://app.netlify.com/drop" target="_blank">üöÄ Open Netlify Drop ‚Üí</a>
        <button class="dismiss-btn" onclick="document.getElementById('setupNotice').style.display='none'">Dismiss</button>
    </div>

    <div class="secure-badge" id="secureBadge">‚úÖ Secure origin ‚Äî tap Start to begin!</div>

    <div class="voice-badge">üéôÔ∏è Tuned for Bass/Baritone Male Voice ¬∑ ~90 Hz ¬∑ Wider targets ¬∑ Smoothed detection</div>

    <div class="controls">
        <button class="btn" id="startBtn">üéôÔ∏è Start Coaching</button>
        <button class="btn" id="stopBtn">‚èπÔ∏è Stop</button>
    </div>

    <!-- SOUND SELECTOR -->
    <div class="selector-section">
        <h2>Select Sound to Practice</h2>
        <div class="tab-row">
            <div class="tab active" id="tabVowels"     onclick="switchTab('vowels')">üó£Ô∏è Vowels</div>
            <div class="tab"        id="tabConsonants" onclick="switchTab('consonants')">üí® Consonants</div>
        </div>
        <div class="sound-grid" id="soundGrid"></div>
    </div>

    <!-- COACHING PANEL -->
    <div class="coaching-panel">
        <div class="current-sound">
            <span class="current-sound-symbol" id="csSymbol">AH</span>
            <div>
                <div class="current-sound-name" id="csName">Open vowel "AH"</div>
                <div class="current-sound-type" id="csType">Low vowel ¬∑ as in "father"</div>
            </div>
        </div>

        <!-- Smoothing indicator -->
        <div class="smoothing-bar" id="smoothingBar">
            <span>Averaging readings:</span>
            <div class="smoothing-dots" id="smoothingDots">
                <div class="dot" id="d0"></div>
                <div class="dot" id="d1"></div>
                <div class="dot" id="d2"></div>
                <div class="dot" id="d3"></div>
                <div class="dot" id="d4"></div>
            </div>
            <span id="smoothingLabel">warming up...</span>
        </div>

        <div class="coach-status waiting" id="coachStatus">
            Select a sound above, tap Start, then sustain that sound clearly...
        </div>
        <div class="adjustment-grid" id="adjustmentGrid"></div>
    </div>

    <!-- TARGETS -->
    <div class="target-display" id="targetDisplay" style="display:none;">
        <h3>Target Formants ¬∑ Male Voice</h3>
        <div class="target-formants-row" id="targetFormants"></div>
    </div>

    <!-- PROGRESS -->
    <div class="progress-section">
        <div class="progress-card">
            <div class="progress-label">Alignment</div>
            <div class="progress-value" id="alignmentScore">0%</div>
            <div class="progress-bar-container">
                <div class="progress-bar" id="alignmentBar" style="width:0%"></div>
            </div>
        </div>
        <div class="progress-card">
            <div class="progress-label">Pharynx</div>
            <div class="progress-value" id="pharynxScore">--</div>
            <div class="progress-bar-container">
                <div class="progress-bar" id="pharynxBar" style="width:0%"></div>
            </div>
        </div>
        <div class="progress-card">
            <div class="progress-label">On Target</div>
            <div class="progress-value" id="formantsAligned">0/4</div>
            <div class="progress-bar-container">
                <div class="progress-bar" id="formantsBar" style="width:0%"></div>
            </div>
        </div>
    </div>

    <!-- SPECTROGRAM -->
    <div class="canvas-wrap">
        <div class="canvas-label">Live Spectrogram</div>
        <canvas id="spectrogram" width="800" height="180"></canvas>
    </div>

    <!-- TIPS -->
    <div class="tips">
        <h3>How to use</h3>
        <div class="tip-item"><strong>üü¢ Green:</strong> You're hitting the target ‚Äî keep it up!</div>
        <div class="tip-item"><strong>üü° Yellow:</strong> Getting close ‚Äî small adjustment needed.</div>
        <div class="tip-item"><strong>üî¥ Red:</strong> Fix this first ‚Äî follow the instruction.</div>
        <div class="tip-item"><strong>‚è≥ Wait for 5 dots:</strong> The app averages 5 readings before coaching ‚Äî hold your sound steady for 3‚Äì4 seconds.</div>
        <div class="tip-item"><strong>üéØ Consonants:</strong> Sustain as long as possible ‚Äî MMM, SSS, NNN, RRR etc.</div>
        <div class="tip-item"><strong>üìä Aim for 70%+</strong> on all three bars for a great result.</div>
    </div>

</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MALE VOICE SOUND DATABASE
// Wider ranges tuned for adult male voices (F0 ~85-180Hz)
// All formant ranges expanded by ~15-20% vs generic values
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SOUNDS = {
    vowels: [
        { symbol:'AH', name:'Open "AH"',      example:'father',
          type:'Low vowel',
          f1:[550,780], f2:[850,1200], f3:[2000,2600], f4:[2700,3200],
          coachTongue:'Keep tongue low and relaxed. Let jaw drop naturally.',
          coachLips:'Lips relaxed and open ‚Äî not rounded, not spread.' },

        { symbol:'EE', name:'Close "EE"',     example:'see',
          type:'High front vowel',
          f1:[180,330], f2:[1800,2450], f3:[2350,2800], f4:[3000,3500],
          coachTongue:'Push tongue high and forward toward your top front teeth.',
          coachLips:'Spread lips wide into a big smile shape.' },

        { symbol:'OO', name:'Close "OO"',     example:'food',
          type:'High back vowel',
          f1:[180,330], f2:[450,800],  f3:[1800,2300], f4:[2500,3000],
          coachTongue:'Raise back of tongue toward soft palate.',
          coachLips:'Round lips into a small tight circle ‚Äî push forward.' },

        { symbol:'OH', name:'Mid "OH"',       example:'go',
          type:'Mid back vowel',
          f1:[300,550], f2:[500,850], f3:[1850,2400], f4:[2600,3100],
          coachTongue:'Tongue mid-height, pulled slightly back.',
          coachLips:'Round lips into a relaxed O ‚Äî not too tight.' },

        { symbol:'AY', name:'Mid "AY"',       example:'day',
          type:'Mid front vowel',
          f1:[300,550], f2:[1400,2000], f3:[2100,2650], f4:[2800,3300],
          coachTongue:'Tongue mid-high and forward ‚Äî glide toward EE.',
          coachLips:'Slightly spread ‚Äî relaxed smile.' },

        { symbol:'EH', name:'Mid "EH"',       example:'bed',
          type:'Mid front vowel',
          f1:[400,660], f2:[1250,1800], f3:[2000,2550], f4:[2700,3200],
          coachTongue:'Tongue mid-height and slightly forward.',
          coachLips:'Lips neutral ‚Äî not spread, not rounded.' },

        { symbol:'IH', name:'Near "IH"',      example:'bit',
          type:'Near-high front',
          f1:[220,440], f2:[1450,1950], f3:[2200,2700], f4:[2900,3400],
          coachTongue:'Tongue high-front but relaxed ‚Äî less tense than EE.',
          coachLips:'Very slight spread ‚Äî nearly neutral.' },

        { symbol:'UH', name:'Mid "UH"',       example:'cup',
          type:'Mid central vowel',
          f1:[400,660], f2:[850,1300], f3:[1900,2500], f4:[2700,3200],
          coachTongue:'Tongue completely relaxed in center of mouth.',
          coachLips:'Lips relaxed and neutral ‚Äî natural resting position.' },

        { symbol:'AW', name:'Open "AW"',      example:'caught',
          type:'Low back rounded',
          f1:[460,720], f2:[500,850], f3:[1850,2400], f4:[2500,3100],
          coachTongue:'Tongue low and pulled back ‚Äî like beginning of a yawn.',
          coachLips:'Round lips loosely ‚Äî not as tight as OO.' },

        { symbol:'ER', name:'R-colored "ER"', example:'bird',
          type:'R-colored vowel',
          f1:[300,550], f2:[900,1400], f3:[1300,1800], f4:[2500,3000],
          coachTongue:'Curl tongue tip back (retroflex) ‚Äî classic R shape.',
          coachLips:'Lips neutral with very slight rounding.' },

        { symbol:'OI', name:'Diphthong "OI"', example:'boy',
          type:'Diphthong',
          f1:[390,660], f2:[500,900], f3:[1850,2400], f4:[2500,3100],
          coachTongue:'Start with OH tongue then glide toward EE.',
          coachLips:'Start rounded then spread as you glide.' },

        { symbol:'OW', name:'Diphthong "OW"', example:'now',
          type:'Diphthong',
          f1:[530,790], f2:[800,1250], f3:[1900,2500], f4:[2600,3200],
          coachTongue:'Start with AH then glide back and up toward OO.',
          coachLips:'Start open then round lips as you glide.' },
    ],

    consonants: [
        { symbol:'MMM', name:'Nasal "M"',      example:'moon',
          type:'Bilabial nasal',
          f1:[180,380], f2:[700,1100], f3:[1700,2300], f4:[null,null],
          coachTongue:'Tongue relaxed ‚Äî it does little for M.',
          coachLips:'Lips firmly closed. Let air go through your nose.' },

        { symbol:'NNN', name:'Nasal "N"',      example:'nose',
          type:'Alveolar nasal',
          f1:[180,380], f2:[900,1350], f3:[1900,2500], f4:[null,null],
          coachTongue:'Press tongue tip firmly against the ridge behind upper front teeth.',
          coachLips:'Lips slightly open. Air goes through nose.' },

        { symbol:'NGG', name:'Nasal "NG"',     example:'sing',
          type:'Velar nasal',
          f1:[180,380], f2:[600,1000], f3:[1600,2200], f4:[null,null],
          coachTongue:'Raise back of tongue to touch soft palate ‚Äî like end of "ring".',
          coachLips:'Lips open. Air through nose.' },

        { symbol:'SSS', name:'Fricative "S"',  example:'sun',
          type:'Alveolar fricative',
          f1:[null,null], f2:[null,null], f3:[3000,4500], f4:[null,null],
          coachTongue:'Tongue tip near but NOT touching the ridge. Create a narrow groove.',
          coachLips:'Teeth close together. Lips slightly spread.' },

        { symbol:'ZZZ', name:'Fricative "Z"',  example:'zoo',
          type:'Voiced fricative',
          f1:[null,null], f2:[null,null], f3:[2600,4000], f4:[null,null],
          coachTongue:'Same position as S but add voice ‚Äî feel buzz in teeth.',
          coachLips:'Teeth close. Lips slightly spread.' },

        { symbol:'SHH', name:'Fricative "SH"', example:'ship',
          type:'Palatal fricative',
          f1:[null,null], f2:[null,null], f3:[2100,3200], f4:[null,null],
          coachTongue:'Tongue blade raised toward hard palate. Tip pointed down.',
          coachLips:'Slight rounding and protrusion ‚Äî this shapes the resonance.' },

        { symbol:'FFF', name:'Fricative "F"',  example:'fish',
          type:'Labiodental fricative',
          f1:[null,null], f2:[null,null], f3:[3000,4500], f4:[null,null],
          coachTongue:'Tongue stays relaxed for F.',
          coachLips:'Upper teeth rest lightly on lower lip. Blow air through gap.' },

        { symbol:'VVV', name:'Fricative "V"',  example:'van',
          type:'Voiced labiodental',
          f1:[150,420], f2:[null,null], f3:[2500,4000], f4:[null,null],
          coachTongue:'Tongue relaxed ‚Äî same as F but add voice.',
          coachLips:'Upper teeth on lower lip ‚Äî add vocal buzz.' },

        { symbol:'LLL', name:'Lateral "L"',   example:'love',
          type:'Alveolar lateral',
          f1:[250,480], f2:[700,1100], f3:[1900,2600], f4:[null,null],
          coachTongue:'Tip touches ridge behind upper teeth. Sides drop to let air pass.',
          coachLips:'Lips relaxed and neutral.' },

        { symbol:'RRR', name:'Approx "R"',    example:'red',
          type:'Approximant',
          f1:[250,480], f2:[500,1000], f3:[1200,1900], f4:[null,null],
          coachTongue:'Curl tongue tip back (retroflex) and keep it OFF the palate.',
          coachLips:'Slight lip rounding helps shape the R resonance.' },

        { symbol:'WWW', name:'Approx "W"',    example:'wet',
          type:'Bilabial approximant',
          f1:[150,380], f2:[450,850],  f3:[1800,2400], f4:[null,null],
          coachTongue:'Back of tongue high ‚Äî like OO vowel position.',
          coachLips:'Start with tight rounded lips then open into next vowel.' },

        { symbol:'YYY', name:'Approx "Y"',    example:'yes',
          type:'Palatal approximant',
          f1:[150,380], f2:[1500,2200], f3:[2200,2800], f4:[null,null],
          coachTongue:'Tongue high and front ‚Äî like EE ‚Äî then glide into next sound.',
          coachLips:'Slightly spread lips opening into next vowel.' },

        { symbol:'HHH', name:'Glottal "H"',   example:'hat',
          type:'Glottal fricative',
          f1:[300,620], f2:[800,1400], f3:[1900,2600], f4:[null,null],
          coachTongue:'Mirror the FOLLOWING vowel position ‚Äî prepare the tongue early.',
          coachLips:'Open and relaxed ‚Äî breathe through an open vocal tract.' },
    ]
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SMOOTHING BUFFER ‚Äî averages last N readings
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SMOOTH_N   = 5;   // number of frames to average
const formantHistory = { f1:[], f2:[], f3:[], f4:[] };

function pushHistory(key, val) {
    formantHistory[key].push(val);
    if (formantHistory[key].length > SMOOTH_N) formantHistory[key].shift();
}

function avgHistory(key) {
    const arr = formantHistory[key];
    if (arr.length === 0) return null;
    return arr.reduce((a,b) => a+b, 0) / arr.length;
}

function clearHistory() {
    Object.keys(formantHistory).forEach(k => formantHistory[k] = []);
}

function historyReady() {
    return formantHistory.f1.length >= SMOOTH_N;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentTab    = 'vowels';
let selectedSound = SOUNDS.vowels[0];
let audioCtx, analyser, microphone, dataArray, animationId;
let spectrogramData = [];
const canvas = document.getElementById('spectrogram');
const ctx2d  = canvas.getContext('2d');

// Origin check
const isSecure = (
    location.protocol === 'https:' ||
    location.hostname === 'localhost' ||
    location.hostname === '127.0.0.1' ||
    location.hostname === '[::1]'
);
if (!isSecure) {
    document.getElementById('setupNotice').classList.add('visible');
    document.getElementById('startBtn').disabled = true;
} else {
    document.getElementById('secureBadge').classList.add('visible');
}

// ‚îÄ‚îÄ Sound grid ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function switchTab(tab) {
    currentTab = tab;
    document.getElementById('tabVowels').classList.toggle('active',     tab === 'vowels');
    document.getElementById('tabConsonants').classList.toggle('active', tab === 'consonants');
    renderGrid();
}

function renderGrid() {
    const grid   = document.getElementById('soundGrid');
    const sounds = SOUNDS[currentTab];
    grid.innerHTML = sounds.map((s, i) => `
        <div class="sound-btn ${s === selectedSound ? 'selected' : ''}"
             onclick="selectSound('${currentTab}',${i})">
            <span class="sound-symbol">${s.symbol}</span>
            <span class="sound-example">${s.example}</span>
        </div>`).join('');
}

function selectSound(tab, i) {
    selectedSound = SOUNDS[tab][i];
    clearHistory();
    renderGrid();
    updateSoundDisplay();
    updateTargetDisplay();
}

function updateSoundDisplay() {
    document.getElementById('csSymbol').textContent = selectedSound.symbol;
    document.getElementById('csName').textContent   = selectedSound.name;
    document.getElementById('csType').textContent   = selectedSound.type + ' ¬∑ "' + selectedSound.example + '"';
}

function updateTargetDisplay(detectedFormants) {
    const row    = document.getElementById('targetFormants');
    const fkeys  = ['f1','f2','f3','f4'];
    const labels = ['F1','F2','F3','F4'];
    row.innerHTML = fkeys.map((fk, i) => {
        const range = selectedSound[fk];
        if (!range || range[0] === null) return `<div class="target-formant">${labels[i]}: N/A</div>`;
        const det = detectedFormants ? detectedFormants[fk] : null;
        const inRange = det && det >= range[0] && det <= range[1];
        return `<div class="target-formant ${inRange ? 'in-range' : ''}">
            ${labels[i]}: ${range[0]}‚Äì${range[1]}Hz
            ${det ? '<br><small>' + Math.round(det) + 'Hz</small>' : ''}
        </div>`;
    }).join('');
}

// ‚îÄ‚îÄ Smoothing dots UI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateSmoothingUI() {
    const n = formantHistory.f1.length;
    for (let i = 0; i < SMOOTH_N; i++) {
        document.getElementById('d' + i).classList.toggle('filled', i < n);
    }
    document.getElementById('smoothingLabel').textContent =
        n < SMOOTH_N ? `hold sound‚Ä¶ (${n}/${SMOOTH_N})` : 'reading stable ‚úì';
}

// ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('startBtn').addEventListener('click', startAnalysis);
document.getElementById('stopBtn').addEventListener('click', stopAnalysis);

async function startAnalysis() {
    try {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === 'suspended') await audioCtx.resume();

        const stream = await navigator.mediaDevices.getUserMedia({
            audio: { echoCancellation: false, noiseSuppression: false, autoGainControl: false }
        });

        analyser   = audioCtx.createAnalyser();
        microphone = audioCtx.createMediaStreamSource(stream);
        analyser.fftSize = 4096;
        analyser.smoothingTimeConstant = 0.8;
        dataArray = new Uint8Array(analyser.frequencyBinCount);
        microphone.connect(analyser);

        document.getElementById('startBtn').style.display = 'none';
        document.getElementById('stopBtn').style.display  = 'inline-block';
        document.getElementById('targetDisplay').style.display = 'block';
        clearHistory();
        draw();
    } catch (err) {
        if (err.name === 'NotAllowedError') {
            alert('Mic blocked.\nSafari: Settings ‚Üí Safari ‚Üí Microphone ‚Üí allow this site.');
        } else {
            alert('Mic error: ' + err.message);
        }
    }
}

function stopAnalysis() {
    if (animationId) cancelAnimationFrame(animationId);
    if (microphone) { microphone.disconnect(); microphone.mediaStream.getTracks().forEach(t => t.stop()); }
    if (audioCtx) audioCtx.close();
    spectrogramData = [];
    clearHistory();
    document.getElementById('startBtn').style.display = 'inline-block';
    document.getElementById('stopBtn').style.display  = 'none';
    document.getElementById('targetDisplay').style.display = 'none';
    resetDisplays();
}

function resetDisplays() {
    const cs = document.getElementById('coachStatus');
    cs.textContent = 'Select a sound above, tap Start, then sustain that sound clearly...';
    cs.className   = 'coach-status waiting';
    document.getElementById('adjustmentGrid').innerHTML    = '';
    document.getElementById('alignmentScore').textContent  = '0%';
    document.getElementById('pharynxScore').textContent    = '--';
    document.getElementById('formantsAligned').textContent = '0/4';
    ['alignment','pharynx','formants'].forEach(id =>
        document.getElementById(id + 'Bar').style.width = '0%'
    );
    for (let i = 0; i < SMOOTH_N; i++) document.getElementById('d'+i).classList.remove('filled');
    document.getElementById('smoothingLabel').textContent = 'warming up...';
}

// ‚îÄ‚îÄ Draw ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function draw() {
    animationId = requestAnimationFrame(draw);
    analyser.getByteFrequencyData(dataArray);

    const maxCols = Math.floor(canvas.width / 2);
    if (spectrogramData.length > maxCols) spectrogramData.shift();
    spectrogramData.push([...dataArray]);

    ctx2d.fillStyle = '#000';
    ctx2d.fillRect(0, 0, canvas.width, canvas.height);

    const sliceW = canvas.width / spectrogramData.length;
    const bwHz   = (audioCtx.sampleRate / 2) / dataArray.length;
    const maxBin = Math.min(dataArray.length, Math.floor(6000 / bwHz));

    for (let i = 0; i < spectrogramData.length; i++) {
        const slice = spectrogramData[i];
        for (let j = 0; j < maxBin; j++) {
            const p = slice[j] / 255;
            let r, g, b;
            if      (p < 0.3) { r = 0;                       g = Math.floor(p*850);      b = 255; }
            else if (p < 0.7) { r = Math.floor((p-0.3)*637); g = 255;                    b = Math.floor((0.7-p)*637); }
            else               { r = 255;                      g = Math.floor((1-p)*850);  b = 0; }
            ctx2d.fillStyle = `rgb(${r},${g},${b})`;
            const y = canvas.height - (j / maxBin) * canvas.height;
            ctx2d.fillRect(i * sliceW, y, sliceW + 0.5, canvas.height / maxBin + 0.5);
        }
    }

    coachingAnalysis(dataArray);
}

// ‚îÄ‚îÄ Analysis ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function coachingAnalysis(fd) {
    const nyquist = audioCtx.sampleRate / 2;
    const bw      = nyquist / fd.length;
    const f0      = detectFundamental(fd, bw);
    const cs      = document.getElementById('coachStatus');

    if (f0 < 70 || f0 > 160) {
        cs.textContent = `üé§ Waiting... sustain "${selectedSound.symbol}" clearly and steadily`;
        cs.className   = 'coach-status waiting';
        clearHistory();
        updateSmoothingUI();
        return;
    }

    // Detect raw formants and push into smoothing buffer
    const rawFormants = detectFormants(fd, bw);
    ['f1','f2','f3','f4'].forEach(fk => {
        const found = rawFormants.find(f => f.name === fk);
        if (found) pushHistory(fk, found.frequency);
    });

    updateSmoothingUI();

    // Wait until buffer is full before coaching
    if (!historyReady()) {
        cs.textContent = `üéµ Hold "${selectedSound.symbol}" steady... averaging readings`;
        cs.className   = 'coach-status analyzing';
        return;
    }

    // Use smoothed values
    const smoothed = {
        f1: avgHistory('f1'),
        f2: avgHistory('f2'),
        f3: avgHistory('f3'),
        f4: avgHistory('f4')
    };

    const harmonics  = detectHarmonics(f0, fd, bw);
    const alignments = calculateAlignment(rawFormants, harmonics);
    const metrics    = calculateMetrics(fd, bw, f0, rawFormants, alignments);

    cs.textContent = `üéµ Coaching "${selectedSound.symbol}" at ${Math.round(f0)} Hz`;
    cs.className   = 'coach-status coaching';

    generateCoaching(smoothed, metrics);
    updateProgress(metrics, rawFormants);
    updateTargetDisplay(smoothed);
}

function detectFundamental(fd, bw) {
    let maxVal = 0, maxBin = 0;
    // Tuned for 90Hz bass/baritone voice ‚Äî search 70-160Hz only
    const lo = Math.floor(70  / bw);
    const hi = Math.floor(160 / bw);
    for (let i = lo; i < hi && i < fd.length; i++) {
        if (fd[i] > maxVal) { maxVal = fd[i]; maxBin = i; }
    }
    return maxVal < 35 ? 0 : maxBin * bw;
}

function detectHarmonics(f0, fd, bw) {
    const out = [];
    for (let h = 1; h <= 15; h++) {
        const freq = f0 * h;
        if (freq > 6000) break;
        const bin = Math.round(freq / bw);
        if (bin >= fd.length) break;
        if (fd[bin] > 25) out.push({ number:h, frequency:freq, amplitude:fd[bin] });
    }
    return out;
}

function detectFormants(fd, bw) {
    const sm = smoothSpectrum(fd);
    return [
        { name:'f1', min: 100, max:1100 },
        { name:'f2', min: 700, max:2900 },
        { name:'f3', min:1700, max:3900 },
        { name:'f4', min:2700, max:5200 }
    ].reduce((acc, r) => {
        const pk = findPeak(sm, bw, r.min, r.max);
        if (pk.frequency > 0 && pk.amplitude > 30)
            acc.push({ name:r.name, frequency:pk.frequency, amplitude:pk.amplitude });
        return acc;
    }, []);
}

function smoothSpectrum(data) {
    const out = new Uint8Array(data.length);
    for (let i = 0; i < data.length; i++) {
        let sum = 0, n = 0;
        for (let j = -7; j <= 7; j++) {
            const k = i+j;
            if (k >= 0 && k < data.length) { sum += data[k]; n++; }
        }
        out[i] = Math.round(sum/n);
    }
    return out;
}

function findPeak(data, bw, minF, maxF) {
    const lo = Math.floor(minF/bw), hi = Math.floor(maxF/bw);
    let pv = 0, pb = 0;
    for (let i = lo; i <= hi && i < data.length; i++) {
        if (data[i] > pv) { pv = data[i]; pb = i; }
    }
    return { frequency: pb*bw, amplitude: pv };
}

function calculateAlignment(formants, harmonics) {
    return harmonics.map(h => {
        let best = null, bestDist = Infinity;
        formants.forEach(f => {
            const d = Math.abs(f.frequency - h.frequency);
            if ((d/h.frequency)*100 < 25 && d < bestDist) { bestDist = d; best = f; }
        });
        const pct    = best ? (bestDist/h.frequency)*100 : 100;
        const status = pct <= 7 ? 'perfect' : pct <= 15 ? 'good' : pct <= 25 ? 'near' : 'none';
        return { harmonic:h, formant:best, distance:bestDist, percentDiff:pct, status };
    });
}

function calculateMetrics(fd, bw, f0, formants, alignments) {
    const low  = energy(fd, bw,  60,  600);
    const high = energy(fd, bw,2000, 5000);
    let alignmentScore = 0;
    alignments.forEach(a => {
        if      (a.status==='perfect') alignmentScore += 10;
        else if (a.status==='good')    alignmentScore += 7;
        else if (a.status==='near')    alignmentScore += 4;
    });
    return {
        pharynxScore:     Math.min(100, (low/255)*220),
        alignmentScore:   Math.min(100, alignmentScore),
        formantsDetected: formants.length,
        alignedCount:     alignments.filter(a => a.status==='perfect'||a.status==='good').length,
        highEnergy:       high,
        lowEnergy:        low
    };
}

function energy(fd, bw, minF, maxF) {
    const lo = Math.floor(minF/bw), hi = Math.floor(maxF/bw);
    let sum = 0, n = 0;
    for (let i = lo; i <= hi && i < fd.length; i++) { sum += fd[i]; n++; }
    return n > 0 ? sum/n : 0;
}

// ‚îÄ‚îÄ Coaching cards ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function generateCoaching(smoothed, metrics) {
    const grid = document.getElementById('adjustmentGrid');
    const s    = selectedSound;
    const adjs = [];

    // Helper: check if smoothed value is in target range
    function inRange(fk) {
        const val   = smoothed[fk];
        const range = s[fk];
        if (!val || !range || range[0] === null) return null; // N/A
        return val >= range[0] && val <= range[1];
    }
    function tooLow(fk)  { const v=smoothed[fk],r=s[fk]; return v&&r&&r[0]!==null&&v<r[0]; }
    function tooHigh(fk) { const v=smoothed[fk],r=s[fk]; return v&&r&&r[0]!==null&&v>r[1]; }

    // ‚îÄ‚îÄ PHARYNX ‚îÄ‚îÄ
    // Thresholds lowered significantly for male voices
    // Male voices naturally have less high-frequency energy so raw score runs lower
    if      (metrics.pharynxScore < 25) adjs.push({
        area:'Pharynx', icon:'üó£Ô∏è', status:'critical', cardClass:'warning',
        instruction:'Try dropping your jaw a little more and thinking of a relaxed yawn feeling.',
        statusText:`‚ö†Ô∏è ${Math.round(metrics.pharynxScore)}% open` });
    else if (metrics.pharynxScore < 40) adjs.push({
        area:'Pharynx', icon:'üó£Ô∏è', status:'needs-work', cardClass:'caution',
        instruction:'Throat is mostly open ‚Äî just relax any remaining tension.',
        statusText:`üëç ${Math.round(metrics.pharynxScore)}% open` });
    else adjs.push({
        area:'Pharynx', icon:'üó£Ô∏è', status:'good', cardClass:'active',
        instruction:'Throat is open and resonant ‚Äî maintain this position!',
        statusText:`‚úÖ ${Math.round(metrics.pharynxScore)}% open` });

    // ‚îÄ‚îÄ TONGUE (F1/F2 based) ‚îÄ‚îÄ
    const f1ok = inRange('f1'), f2ok = inRange('f2');
    if (f1ok === null && f2ok === null) {
        // consonant ‚Äî just show guidance
        adjs.push({ area:'Tongue', icon:'üëÖ', status:'good', cardClass:'active',
            instruction: s.coachTongue,
            statusText:'‚ÑπÔ∏è Follow tongue tip above' });
    } else if (f1ok && f2ok) {
        adjs.push({ area:'Tongue', icon:'üëÖ', status:'good', cardClass:'active',
            instruction:`Perfect tongue position for "${s.symbol}"! ${s.coachTongue}`,
            statusText:`‚úÖ F1:${Math.round(smoothed.f1)}Hz F2:${smoothed.f2?Math.round(smoothed.f2)+'Hz':'‚Äî'}` });
    } else if (tooLow('f1')) {
        adjs.push({ area:'Tongue', icon:'üëÖ', status:'needs-work', cardClass:'caution',
            instruction:`F1 too low (${Math.round(smoothed.f1)}Hz, target ${s.f1[0]}‚Äì${s.f1[1]}Hz). Raise tongue slightly or open jaw more.`,
            statusText:`‚ö†Ô∏è F1 too low ‚Äî raise tongue` });
    } else if (tooHigh('f1')) {
        adjs.push({ area:'Tongue', icon:'üëÖ', status:'needs-work', cardClass:'caution',
            instruction:`F1 too high (${Math.round(smoothed.f1)}Hz, target ${s.f1[0]}‚Äì${s.f1[1]}Hz). Lower tongue or relax jaw.`,
            statusText:`‚ö†Ô∏è F1 too high ‚Äî lower tongue` });
    } else if (!f2ok && smoothed.f2) {
        adjs.push({ area:'Tongue', icon:'üëÖ', status:'needs-work', cardClass:'caution',
            instruction:`F2 off target (${Math.round(smoothed.f2)}Hz, target ${s.f2[0]}‚Äì${s.f2[1]}Hz). ${s.coachTongue}`,
            statusText:`‚ö†Ô∏è F2 needs adjustment` });
    } else {
        adjs.push({ area:'Tongue', icon:'üëÖ', status:'critical', cardClass:'warning',
            instruction:`Formant not detected. ${s.coachTongue} Make sure you're sustaining the sound clearly.`,
            statusText:'‚ùå Hold the sound longer' });
    }

    // ‚îÄ‚îÄ LIPS (F3/high energy based) ‚îÄ‚îÄ
    const f3ok = inRange('f3');
    if (f3ok === null) {
        adjs.push({ area:'Lips', icon:'üíã', status:'good', cardClass:'active',
            instruction: s.coachLips,
            statusText:'‚ÑπÔ∏è Follow lip guidance above' });
    } else if (f3ok) {
        adjs.push({ area:'Lips', icon:'üíã', status:'good', cardClass:'active',
            instruction:`Great lip shape for "${s.symbol}"! ${s.coachLips}`,
            statusText:`‚úÖ F3:${smoothed.f3?Math.round(smoothed.f3)+'Hz':'in range'}` });
    } else if (metrics.highEnergy > 55) {
        adjs.push({ area:'Lips', icon:'üíã', status:'good', cardClass:'active',
            instruction:`Good resonance energy. ${s.coachLips}`,
            statusText:'‚úÖ Resonance detected' });
    } else {
        adjs.push({ area:'Lips', icon:'üíã', status:'needs-work', cardClass:'caution',
            instruction:`Adjust lip shape for "${s.symbol}": ${s.coachLips}`,
            statusText:'‚ö†Ô∏è Try adjusting lip shape' });
    }

    grid.innerHTML = adjs.map(a => `
        <div class="adjustment-card ${a.cardClass}">
            <div class="adjustment-title">
                <span class="adjustment-icon">${a.icon}</span>
                <span>${a.area}</span>
            </div>
            <div class="adjustment-instruction">${a.instruction}</div>
            <div class="adjustment-status status-${a.status}">${a.statusText}</div>
        </div>`).join('');
}

function updateProgress(metrics, formants) {
    document.getElementById('alignmentScore').textContent  = Math.round(metrics.alignmentScore) + '%';
    document.getElementById('alignmentBar').style.width    = metrics.alignmentScore + '%';
    document.getElementById('pharynxScore').textContent    = Math.round(metrics.pharynxScore) + '%';
    document.getElementById('pharynxBar').style.width      = metrics.pharynxScore + '%';
    document.getElementById('formantsAligned').textContent = `${metrics.alignedCount}/${metrics.formantsDetected}`;
    const pct = metrics.formantsDetected > 0 ? (metrics.alignedCount/metrics.formantsDetected)*100 : 0;
    document.getElementById('formantsBar').style.width = pct + '%';
}

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
renderGrid();
updateSoundDisplay();
updateTargetDisplay();
</script>
</body>
</html>
