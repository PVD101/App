<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Formant Tuning Coach</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg:       #080c14;
            --surface:  #0f1624;
            --card:     #151e30;
            --border:   #1e2d47;
            --accent:   #00d4ff;
            --accent2:  #7c3aed;
            --green:    #00e896;
            --yellow:   #ffd600;
            --red:      #ff3d71;
            --text:     #e8f0fe;
            --muted:    #6b7fa3;
            --font:     'Outfit', sans-serif;
            --mono:     'JetBrains Mono', monospace;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font);
            background: var(--bg);
            min-height: 100vh;
            color: var(--text);
            -webkit-overflow-scrolling: touch;
            overflow-x: hidden;
        }

        /* Background grid */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background-image:
                linear-gradient(rgba(0,212,255,0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0,212,255,0.03) 1px, transparent 1px);
            background-size: 40px 40px;
            pointer-events: none;
            z-index: 0;
        }

        .wrap {
            position: relative;
            z-index: 1;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px 16px 40px;
        }

        /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
        header {
            text-align: center;
            margin-bottom: 24px;
            padding: 30px 20px 24px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 24px;
            position: relative;
            overflow: hidden;
        }

        header::after {
            content: '';
            position: absolute;
            top: -40px; left: 50%;
            transform: translateX(-50%);
            width: 300px; height: 100px;
            background: radial-gradient(ellipse, rgba(0,212,255,0.15), transparent 70%);
            pointer-events: none;
        }

        header h1 {
            font-size: clamp(1.6em, 5vw, 2.4em);
            font-weight: 900;
            letter-spacing: -1px;
            background: linear-gradient(135deg, var(--accent), var(--accent2));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 6px;
        }

        header p {
            color: var(--muted);
            font-size: 0.9em;
            font-weight: 300;
        }

        .live-dot {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(255,61,113,0.15);
            border: 1px solid rgba(255,61,113,0.4);
            color: var(--red);
            padding: 5px 14px;
            border-radius: 20px;
            font-size: 0.78em;
            font-weight: 700;
            letter-spacing: 2px;
            text-transform: uppercase;
            margin-top: 12px;
        }

        .live-dot::before {
            content: '';
            width: 7px; height: 7px;
            background: var(--red);
            border-radius: 50%;
            animation: blink 1.2s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50%       { opacity: 0.2; }
        }

        /* ‚îÄ‚îÄ SECURE NOTICE ‚îÄ‚îÄ */
        .secure-badge {
            display: none;
            background: rgba(0,232,150,0.1);
            border: 1px solid rgba(0,232,150,0.3);
            color: var(--green);
            padding: 10px 16px;
            border-radius: 12px;
            margin-bottom: 16px;
            text-align: center;
            font-weight: 600;
            font-size: 0.85em;
        }
        .secure-badge.visible { display: block; }

        .setup-notice {
            background: rgba(0,212,255,0.07);
            border: 1px solid rgba(0,212,255,0.25);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            display: none;
        }
        .setup-notice.visible { display: block; }
        .setup-notice h3 { color: var(--accent); font-size: 1em; margin-bottom: 10px; }
        .setup-notice p  { color: var(--muted); font-size: 0.88em; line-height: 1.6; margin-bottom: 8px; }
        .setup-notice ol { margin-left: 18px; color: var(--text); font-size: 0.88em; line-height: 1.8; }
        .netlify-btn {
            display: block;
            background: linear-gradient(135deg, #00ad9f, #00796b);
            color: white;
            text-align: center;
            padding: 12px;
            border-radius: 10px;
            font-weight: 700;
            text-decoration: none;
            margin-top: 12px;
            font-size: 0.9em;
            touch-action: manipulation;
        }
        .dismiss-btn {
            display: block;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--muted);
            padding: 9px;
            border-radius: 10px;
            font-size: 0.85em;
            margin-top: 8px;
            width: 100%;
            cursor: pointer;
            touch-action: manipulation;
        }

        /* ‚îÄ‚îÄ CONTROLS ‚îÄ‚îÄ */
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .btn {
            padding: 14px 28px;
            font-family: var(--font);
            font-size: 0.95em;
            font-weight: 700;
            border: none;
            border-radius: 14px;
            cursor: pointer;
            letter-spacing: 1px;
            text-transform: uppercase;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            transition: opacity 0.2s, transform 0.1s;
        }
        .btn:active { opacity: 0.75; transform: scale(0.97); }
        .btn:disabled { opacity: 0.35; cursor: not-allowed; }

        #startBtn {
            background: linear-gradient(135deg, var(--accent), var(--accent2));
            color: white;
        }
        #stopBtn {
            background: var(--red);
            color: white;
            display: none;
        }

        /* ‚îÄ‚îÄ SOUND SELECTOR ‚îÄ‚îÄ */
        .selector-section {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .selector-section h2 {
            font-size: 0.75em;
            font-weight: 700;
            letter-spacing: 3px;
            text-transform: uppercase;
            color: var(--accent);
            margin-bottom: 16px;
        }

        .tab-row {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .tab {
            flex: 1;
            padding: 10px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--muted);
            font-family: var(--font);
            font-weight: 700;
            font-size: 0.85em;
            cursor: pointer;
            text-align: center;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            transition: all 0.2s;
        }
        .tab.active {
            background: linear-gradient(135deg, rgba(0,212,255,0.2), rgba(124,58,237,0.2));
            border-color: var(--accent);
            color: var(--accent);
        }

        .sound-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(64px, 1fr));
            gap: 8px;
        }

        .sound-btn {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 10px 4px;
            text-align: center;
            cursor: pointer;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            transition: all 0.2s;
        }

        .sound-btn:active { transform: scale(0.93); }

        .sound-btn.selected {
            background: linear-gradient(135deg, rgba(0,212,255,0.2), rgba(124,58,237,0.2));
            border-color: var(--accent);
        }

        .sound-symbol {
            font-size: 1.4em;
            font-weight: 900;
            color: var(--text);
            display: block;
            line-height: 1;
            margin-bottom: 3px;
        }
        .sound-btn.selected .sound-symbol { color: var(--accent); }

        .sound-example {
            font-size: 0.65em;
            color: var(--muted);
            display: block;
        }
        .sound-btn.selected .sound-example { color: var(--accent); }

        /* ‚îÄ‚îÄ COACHING PANEL ‚îÄ‚îÄ */
        .coaching-panel {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .coach-status {
            text-align: center;
            font-size: clamp(0.95em, 3vw, 1.2em);
            padding: 16px;
            background: var(--card);
            border-radius: 12px;
            margin-bottom: 16px;
            line-height: 1.4;
            font-weight: 600;
            border: 1px solid var(--border);
        }
        .coach-status.waiting   { color: var(--muted); }
        .coach-status.analyzing { color: var(--yellow); animation: pulse 1.5s infinite; }
        .coach-status.coaching  { color: var(--green); }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50%       { opacity: 0.6; }
        }

        .adjustment-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
        }
        @media (min-width: 600px) {
            .adjustment-grid { grid-template-columns: repeat(3, 1fr); }
        }

        .adjustment-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 16px;
            transition: all 0.3s;
        }
        .adjustment-card.active {
            border-color: var(--green);
            background: rgba(0,232,150,0.07);
            box-shadow: 0 0 20px rgba(0,232,150,0.1);
        }
        .adjustment-card.warning {
            border-color: var(--red);
            background: rgba(255,61,113,0.07);
            box-shadow: 0 0 20px rgba(255,61,113,0.1);
            animation: shake 0.4s;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25%       { transform: translateX(-6px); }
            75%       { transform: translateX(6px); }
        }

        .adjustment-title {
            font-size: 1em;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--accent);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .adjustment-icon { font-size: 1.4em; }

        .adjustment-instruction {
            font-size: 0.88em;
            line-height: 1.5;
            color: var(--text);
            opacity: 0.85;
        }

        .adjustment-status {
            margin-top: 8px;
            padding: 7px 10px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            font-weight: 700;
            font-size: 0.82em;
            font-family: var(--mono);
        }
        .status-good       { color: var(--green); }
        .status-needs-work { color: var(--yellow); }
        .status-critical   { color: var(--red); }

        /* ‚îÄ‚îÄ TARGET FORMANTS ‚îÄ‚îÄ */
        .target-display {
            background: var(--surface);
            border: 1px solid rgba(255,214,0,0.3);
            padding: 16px;
            border-radius: 16px;
            margin-bottom: 20px;
            text-align: center;
        }
        .target-display h3 {
            color: var(--yellow);
            font-size: 0.75em;
            letter-spacing: 3px;
            text-transform: uppercase;
            margin-bottom: 12px;
        }
        .target-formants-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }
        .target-formant {
            background: var(--card);
            border: 1px solid rgba(255,214,0,0.25);
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 0.85em;
            font-weight: 700;
            color: var(--yellow);
            font-family: var(--mono);
        }

        /* ‚îÄ‚îÄ PROGRESS ‚îÄ‚îÄ */
        .progress-section {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .progress-card {
            background: var(--surface);
            border: 1px solid var(--border);
            padding: 14px 10px;
            border-radius: 16px;
            text-align: center;
        }
        .progress-label {
            color: var(--muted);
            font-weight: 600;
            font-size: clamp(0.65em, 2vw, 0.78em);
            letter-spacing: 1px;
            text-transform: uppercase;
            margin-bottom: 6px;
        }
        .progress-value {
            font-size: clamp(1.3em, 4vw, 1.9em);
            font-weight: 900;
            color: var(--text);
            font-family: var(--mono);
        }
        .progress-bar-container {
            background: var(--card);
            height: 6px;
            border-radius: 3px;
            margin-top: 8px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--green));
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        /* ‚îÄ‚îÄ SPECTROGRAM ‚îÄ‚îÄ */
        .canvas-wrap {
            background: #000;
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 12px;
            margin-bottom: 20px;
            position: relative;
        }
        .canvas-label {
            font-size: 0.7em;
            color: var(--muted);
            letter-spacing: 2px;
            text-transform: uppercase;
            margin-bottom: 8px;
        }
        canvas { display: block; width: 100%; height: auto; border-radius: 8px; }

        /* ‚îÄ‚îÄ TIPS ‚îÄ‚îÄ */
        .tips {
            background: var(--surface);
            border: 1px solid rgba(0,232,150,0.2);
            padding: 16px;
            border-radius: 16px;
        }
        .tips h3 {
            color: var(--green);
            margin-bottom: 12px;
            font-size: 0.75em;
            letter-spacing: 3px;
            text-transform: uppercase;
        }
        .tip-item {
            padding: 9px 12px;
            margin: 6px 0;
            background: var(--card);
            border-left: 3px solid var(--green);
            border-radius: 0 8px 8px 0;
            font-size: 0.87em;
            line-height: 1.4;
            color: var(--text);
            opacity: 0.85;
        }

        /* ‚îÄ‚îÄ CURRENT SOUND DISPLAY ‚îÄ‚îÄ */
        .current-sound {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 8px 16px;
            margin-bottom: 16px;
            font-size: 0.9em;
        }
        .current-sound-symbol {
            font-size: 1.8em;
            font-weight: 900;
            color: var(--accent);
        }
        .current-sound-info { text-align: left; }
        .current-sound-name { font-weight: 700; color: var(--text); font-size: 0.95em; }
        .current-sound-type { color: var(--muted); font-size: 0.78em; }
    </style>
</head>
<body>
<div class="wrap">

    <header>
        <h1>üéØ Formant Tuning Coach</h1>
        <p>Real-time vowel &amp; consonant articulation guidance</p>
        <div class="live-dot">Live Coaching</div>
    </header>

    <!-- FILE:// WARNING -->
    <div class="setup-notice" id="setupNotice">
        <h3>üì± Hosting required for iPhone Safari mic access</h3>
        <p>Safari on iPhone requires HTTPS. Upload this file to Netlify Drop (free, 60 seconds):</p>
        <ol>
            <li>On a computer go to <strong>app.netlify.com/drop</strong></li>
            <li>Drag this HTML file onto the page</li>
            <li>Copy the free URL and open it in Safari on iPhone</li>
            <li>Tap Allow for microphone</li>
        </ol>
        <a class="netlify-btn" href="https://app.netlify.com/drop" target="_blank">üöÄ Open Netlify Drop ‚Üí</a>
        <button class="dismiss-btn" onclick="document.getElementById('setupNotice').style.display='none'">Dismiss</button>
    </div>

    <div class="secure-badge" id="secureBadge">‚úÖ Secure origin ‚Äî tap Start to begin!</div>

    <!-- CONTROLS -->
    <div class="controls">
        <button class="btn" id="startBtn">üéôÔ∏è Start Coaching</button>
        <button class="btn" id="stopBtn">‚èπÔ∏è Stop</button>
    </div>

    <!-- SOUND SELECTOR -->
    <div class="selector-section">
        <h2>Select Sound to Practice</h2>
        <div class="tab-row">
            <div class="tab active" id="tabVowels" onclick="switchTab('vowels')">Vowels</div>
            <div class="tab" id="tabConsonants" onclick="switchTab('consonants')">Consonants</div>
        </div>
        <div class="sound-grid" id="soundGrid"></div>
    </div>

    <!-- COACHING -->
    <div class="coaching-panel">
        <div style="text-align:center; margin-bottom:14px;">
            <div class="current-sound" id="currentSoundDisplay">
                <span class="current-sound-symbol" id="csSymbol">AH</span>
                <div class="current-sound-info">
                    <div class="current-sound-name" id="csName">Open vowel "AH"</div>
                    <div class="current-sound-type" id="csType">Vowel ¬∑ as in "father"</div>
                </div>
            </div>
        </div>
        <div class="coach-status waiting" id="coachStatus">
            Select a sound above, tap Start, then produce that sound...
        </div>
        <div class="adjustment-grid" id="adjustmentGrid"></div>
    </div>

    <!-- TARGETS -->
    <div class="target-display" id="targetDisplay" style="display:none;">
        <h3>Target Formants</h3>
        <div class="target-formants-row" id="targetFormants"></div>
    </div>

    <!-- PROGRESS -->
    <div class="progress-section">
        <div class="progress-card">
            <div class="progress-label">Alignment</div>
            <div class="progress-value" id="alignmentScore">0%</div>
            <div class="progress-bar-container">
                <div class="progress-bar" id="alignmentBar" style="width:0%"></div>
            </div>
        </div>
        <div class="progress-card">
            <div class="progress-label">Pharynx</div>
            <div class="progress-value" id="pharynxScore">--</div>
            <div class="progress-bar-container">
                <div class="progress-bar" id="pharynxBar" style="width:0%"></div>
            </div>
        </div>
        <div class="progress-card">
            <div class="progress-label">Formants</div>
            <div class="progress-value" id="formantsAligned">0/4</div>
            <div class="progress-bar-container">
                <div class="progress-bar" id="formantsBar" style="width:0%"></div>
            </div>
        </div>
    </div>

    <!-- SPECTROGRAM -->
    <div class="canvas-wrap">
        <div class="canvas-label">Live Spectrogram</div>
        <canvas id="spectrogram" width="800" height="180"></canvas>
    </div>

    <!-- TIPS -->
    <div class="tips">
        <h3>How to use</h3>
        <div class="tip-item"><strong>üü¢ Green card:</strong> Great ‚Äî keep it up!</div>
        <div class="tip-item"><strong>üî¥ Red card:</strong> Fix this first ‚Äî follow the instruction.</div>
        <div class="tip-item"><strong>üìä Bars:</strong> Aim for 70%+ on all three metrics.</div>
        <div class="tip-item"><strong>üîÑ Switch sounds:</strong> Tap any vowel or consonant above to change target.</div>
        <div class="tip-item"><strong>üéØ Consonants:</strong> Hold the sound as long as possible ‚Äî use sustained versions like MMM, SSS, NNN.</div>
    </div>

</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SOUND DATABASE ‚Äî Vowels + Consonants
// F1, F2, F3, F4 targets in Hz. null = not critical for that sound.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SOUNDS = {
    vowels: [
        { symbol:'AH', name:'Open "AH"',    example:'father',  type:'Low vowel',
          f1:[700,900], f2:[1000,1300], f3:[2500,3000], f4:[3200,3800],
          pharynx:'open', tongue:'low-back', lips:'neutral',
          coachTongue:'Keep tongue low and relaxed at back of mouth.',
          coachLips:'Lips relaxed and slightly open ‚Äî not rounded.' },

        { symbol:'EE', name:'Close "EE"',   example:'see',     type:'High front vowel',
          f1:[200,400], f2:[2200,2800], f3:[2800,3400], f4:[3500,4000],
          pharynx:'moderate', tongue:'high-front', lips:'spread',
          coachTongue:'Raise tongue high and push forward toward top front teeth.',
          coachLips:'Spread lips wide ‚Äî think of a big smile.' },

        { symbol:'OO', name:'Close "OO"',   example:'food',    type:'High back vowel',
          f1:[200,400], f2:[600,900],  f3:[2200,2600], f4:[3000,3500],
          pharynx:'open', tongue:'high-back', lips:'rounded',
          coachTongue:'Raise back of tongue toward soft palate.',
          coachLips:'Round lips into a small tight circle and push forward.' },

        { symbol:'OH', name:'Mid "OH"',     example:'go',      type:'Mid back vowel',
          f1:[400,600], f2:[700,1000], f3:[2300,2700], f4:[3100,3600],
          pharynx:'open', tongue:'mid-back', lips:'rounded',
          coachTongue:'Tongue mid-height, pulled slightly back.',
          coachLips:'Round lips into an O shape ‚Äî not too tight.' },

        { symbol:'AY', name:'Mid "AY"',     example:'day',     type:'Mid front vowel',
          f1:[400,600], f2:[1800,2200], f3:[2600,3100], f4:[3300,3800],
          pharynx:'moderate', tongue:'mid-front', lips:'spread',
          coachTongue:'Tongue mid-high and forward ‚Äî glide from E toward EE.',
          coachLips:'Slightly spread lips ‚Äî relaxed smile.' },

        { symbol:'EH', name:'Mid "EH"',     example:'bed',     type:'Mid front vowel',
          f1:[500,700], f2:[1700,2100], f3:[2500,3000], f4:[3200,3700],
          pharynx:'moderate', tongue:'mid-front', lips:'neutral',
          coachTongue:'Tongue mid-height and slightly forward.',
          coachLips:'Lips neutral ‚Äî not spread, not rounded.' },

        { symbol:'IH', name:'Near "IH"',    example:'bit',     type:'Near-high front',
          f1:[300,500], f2:[1900,2300], f3:[2700,3200], f4:[3400,3900],
          pharynx:'moderate', tongue:'high-front-lax', lips:'neutral',
          coachTongue:'Tongue high-front but relaxed ‚Äî not as tense as EE.',
          coachLips:'Lips neutral ‚Äî very slight spread.' },

        { symbol:'UH', name:'Mid "UH"',     example:'cup',     type:'Mid central vowel',
          f1:[500,700], f2:[1000,1400], f3:[2400,2900], f4:[3200,3700],
          pharynx:'open', tongue:'mid-central', lips:'neutral',
          coachTongue:'Tongue relaxed in center of mouth ‚Äî no tension.',
          coachLips:'Lips relaxed and neutral ‚Äî natural resting position.' },

        { symbol:'AW', name:'Open "AW"',    example:'caught',  type:'Low back rounded',
          f1:[600,800], f2:[700,1000], f3:[2300,2700], f4:[3000,3500],
          pharynx:'open', tongue:'low-back', lips:'rounded',
          coachTongue:'Tongue low and pulled back ‚Äî like a yawn.',
          coachLips:'Round lips loosely ‚Äî not as tight as OO.' },

        { symbol:'OI', name:'Diphthong "OI"', example:'boy',   type:'Diphthong',
          f1:[500,700], f2:[700,1100], f3:[2300,2700], f4:[3000,3500],
          pharynx:'open', tongue:'glide', lips:'rounded-to-spread',
          coachTongue:'Start with OH tongue position then glide toward EE.',
          coachLips:'Start rounded then spread as you glide.' },

        { symbol:'OW', name:'Diphthong "OW"', example:'now',   type:'Diphthong',
          f1:[700,900], f2:[1000,1400], f3:[2400,2800], f4:[3100,3600],
          pharynx:'open', tongue:'glide', lips:'open-to-rounded',
          coachTongue:'Start with AH then glide back and up toward OO.',
          coachLips:'Start open then round lips as you glide.' },

        { symbol:'ER', name:'R-colored "ER"', example:'bird',  type:'R-colored vowel',
          f1:[400,600], f2:[1300,1700], f3:[1700,2100], f4:[3000,3500],
          pharynx:'moderate', tongue:'mid-retroflex', lips:'neutral',
          coachTongue:'Curl tongue tip back or bunch the tongue body ‚Äî classic R shape.',
          coachLips:'Lips neutral ‚Äî slight rounding optional.' },
    ],

    consonants: [
        { symbol:'MMM', name:'Nasal "M"',    example:'moon',   type:'Bilabial nasal',
          f1:[200,400], f2:[900,1200], f3:[2000,2500], f4:[null,null],
          pharynx:'moderate', tongue:'neutral', lips:'closed',
          coachTongue:'Tongue relaxed ‚Äî it does not do much for M.',
          coachLips:'Lips firmly closed. Air goes through nose.' },

        { symbol:'NNN', name:'Nasal "N"',    example:'nose',   type:'Alveolar nasal',
          f1:[200,400], f2:[1100,1500], f3:[2200,2700], f4:[null,null],
          pharynx:'moderate', tongue:'alveolar', lips:'open',
          coachTongue:'Tongue tip presses against ridge behind upper front teeth.',
          coachLips:'Lips slightly open. Air through nose.' },

        { symbol:'NGG', name:'Nasal "NG"',   example:'sing',   type:'Velar nasal',
          f1:[200,400], f2:[800,1100], f3:[1900,2400], f4:[null,null],
          pharynx:'moderate', tongue:'velar', lips:'open',
          coachTongue:'Back of tongue raises to touch soft palate ‚Äî like end of "sing".',
          coachLips:'Lips open. Air through nose.' },

        { symbol:'SSS', name:'Fricative "S"', example:'sun',   type:'Alveolar fricative',
          f1:[null,null], f2:[null,null], f3:[3500,5000], f4:[null,null],
          pharynx:'moderate', tongue:'groove', lips:'spread',
          coachTongue:'Tongue tip near but not touching ridge. Create a narrow groove for airflow.',
          coachLips:'Lips slightly spread ‚Äî teeth close together.' },

        { symbol:'ZZZ', name:'Fricative "Z"', example:'zoo',   type:'Voiced alveolar fricative',
          f1:[null,null], f2:[null,null], f3:[3000,4500], f4:[null,null],
          pharynx:'moderate', tongue:'groove', lips:'spread',
          coachTongue:'Same as S but add voice ‚Äî feel vibration in tongue and teeth.',
          coachLips:'Lips slightly spread ‚Äî teeth close together.' },

        { symbol:'SHH', name:'Fricative "SH"', example:'ship', type:'Palatal fricative',
          f1:[null,null], f2:[null,null], f3:[2500,3500], f4:[null,null],
          pharynx:'moderate', tongue:'palatal', lips:'rounded',
          coachTongue:'Tongue blade (not tip) raised toward hard palate. Tip down.',
          coachLips:'Slight lip rounding and protrusion ‚Äî this shapes the resonance.' },

        { symbol:'FFF', name:'Fricative "F"', example:'fish',  type:'Labiodental fricative',
          f1:[null,null], f2:[null,null], f3:[3500,5000], f4:[null,null],
          pharynx:'moderate', tongue:'neutral', lips:'labiodental',
          coachTongue:'Tongue stays relaxed for F.',
          coachLips:'Upper teeth rest lightly on lower lip. Push air through the gap.' },

        { symbol:'VVV', name:'Fricative "V"', example:'van',   type:'Voiced labiodental',
          f1:[200,500], f2:[null,null], f3:[3000,4500], f4:[null,null],
          pharynx:'moderate', tongue:'neutral', lips:'labiodental',
          coachTongue:'Tongue stays relaxed ‚Äî same as F but voiced.',
          coachLips:'Upper teeth on lower lip ‚Äî add voice vibration.' },

        { symbol:'LLL', name:'Lateral "L"',  example:'love',   type:'Alveolar lateral',
          f1:[300,500], f2:[900,1200], f3:[2400,2900], f4:[null,null],
          pharynx:'moderate', tongue:'lateral', lips:'neutral',
          coachTongue:'Tongue tip touches ridge behind upper teeth. Sides of tongue drop to let air pass.',
          coachLips:'Lips relaxed and neutral.' },

        { symbol:'RRR', name:'Approximant "R"', example:'red', type:'Alveolar approximant',
          f1:[300,500], f2:[700,1100], f3:[1600,2000], f4:[null,null],
          pharynx:'moderate', tongue:'retroflex', lips:'slight-round',
          coachTongue:'Curl tongue tip back (retroflex) OR bunch the tongue body. Keep it off the palate.',
          coachLips:'Slight lip rounding helps shape the R resonance.' },

        { symbol:'WWW', name:'Approximant "W"', example:'wet', type:'Bilabial approximant',
          f1:[200,400], f2:[600,900],  f3:[2200,2700], f4:[null,null],
          pharynx:'open', tongue:'high-back', lips:'rounded',
          coachTongue:'Back of tongue high ‚Äî like OO vowel position.',
          coachLips:'Start with tight rounded lips then open into the following vowel.' },

        { symbol:'YYY', name:'Approximant "Y"', example:'yes', type:'Palatal approximant',
          f1:[200,400], f2:[1800,2400], f3:[2700,3200], f4:[null,null],
          pharynx:'moderate', tongue:'high-front', lips:'spread',
          coachTongue:'Tongue high and front ‚Äî like EE vowel ‚Äî then glide into next sound.',
          coachLips:'Slightly spread lips that open into the following vowel.' },

        { symbol:'HHH', name:'Fricative "H"',  example:'hat',  type:'Glottal fricative',
          f1:[400,700], f2:[1000,1500], f3:[2300,2800], f4:[null,null],
          pharynx:'open', tongue:'neutral', lips:'neutral',
          coachTongue:'Tongue position mirrors the FOLLOWING vowel ‚Äî prepare early.',
          coachLips:'Lips open and relaxed ‚Äî breathe through an open vocal tract.' },
    ]
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentTab      = 'vowels';
let selectedSound   = SOUNDS.vowels[0];
let audioCtx, analyser, microphone, dataArray, animationId;
let spectrogramData = [];
const canvas = document.getElementById('spectrogram');
const ctx2d  = canvas.getContext('2d');

// ‚îÄ‚îÄ Origin check ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const isSecure = (
    location.protocol === 'https:' ||
    location.hostname === 'localhost' ||
    location.hostname === '127.0.0.1' ||
    location.hostname === '[::1]'
);
if (!isSecure) {
    document.getElementById('setupNotice').classList.add('visible');
    document.getElementById('startBtn').disabled = true;
} else {
    document.getElementById('secureBadge').classList.add('visible');
}

// ‚îÄ‚îÄ Render sound grid ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function switchTab(tab) {
    currentTab = tab;
    document.getElementById('tabVowels').classList.toggle('active',    tab === 'vowels');
    document.getElementById('tabConsonants').classList.toggle('active', tab === 'consonants');
    renderGrid();
}

function renderGrid() {
    const grid   = document.getElementById('soundGrid');
    const sounds = SOUNDS[currentTab];
    grid.innerHTML = sounds.map((s, i) => `
        <div class="sound-btn ${s === selectedSound ? 'selected' : ''}"
             onclick="selectSound('${currentTab}', ${i})">
            <span class="sound-symbol">${s.symbol}</span>
            <span class="sound-example">${s.example}</span>
        </div>`).join('');
}

function selectSound(tab, index) {
    selectedSound = SOUNDS[tab][index];
    renderGrid();
    updateCurrentSoundDisplay();
    updateTargetFormantsDisplay();
}

function updateCurrentSoundDisplay() {
    document.getElementById('csSymbol').textContent = selectedSound.symbol;
    document.getElementById('csName').textContent   = selectedSound.name;
    document.getElementById('csType').textContent   = selectedSound.type + ' ¬∑ "' + selectedSound.example + '"';
}

function updateTargetFormantsDisplay() {
    const row = document.getElementById('targetFormants');
    const fmts = ['F1','F2','F3','F4'];
    row.innerHTML = fmts.map((f, i) => {
        const range = selectedSound[f.toLowerCase()];
        if (!range || range[0] === null) return `<div class="target-formant">${f}: N/A</div>`;
        return `<div class="target-formant">${f}: ${range[0]}‚Äì${range[1]}Hz</div>`;
    }).join('');
}

// ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('startBtn').addEventListener('click', startAnalysis);
document.getElementById('stopBtn').addEventListener('click', stopAnalysis);

async function startAnalysis() {
    try {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === 'suspended') await audioCtx.resume();

        const stream = await navigator.mediaDevices.getUserMedia({
            audio: { echoCancellation: false, noiseSuppression: false, autoGainControl: false }
        });

        analyser   = audioCtx.createAnalyser();
        microphone = audioCtx.createMediaStreamSource(stream);
        analyser.fftSize = 4096;
        analyser.smoothingTimeConstant = 0.75;
        dataArray = new Uint8Array(analyser.frequencyBinCount);
        microphone.connect(analyser);

        document.getElementById('startBtn').style.display = 'none';
        document.getElementById('stopBtn').style.display  = 'inline-block';
        document.getElementById('targetDisplay').style.display = 'block';

        draw();
    } catch (err) {
        if (err.name === 'NotAllowedError') {
            alert('Microphone blocked.\n\nSafari: Settings ‚Üí Safari ‚Üí Microphone ‚Üí allow this site.');
        } else {
            alert('Mic error: ' + err.message);
        }
    }
}

function stopAnalysis() {
    if (animationId) cancelAnimationFrame(animationId);
    if (microphone) { microphone.disconnect(); microphone.mediaStream.getTracks().forEach(t => t.stop()); }
    if (audioCtx) audioCtx.close();
    spectrogramData = [];
    document.getElementById('startBtn').style.display = 'inline-block';
    document.getElementById('stopBtn').style.display  = 'none';
    document.getElementById('targetDisplay').style.display = 'none';
    resetDisplays();
}

function resetDisplays() {
    const cs = document.getElementById('coachStatus');
    cs.textContent = 'Select a sound above, tap Start, then produce that sound...';
    cs.className   = 'coach-status waiting';
    document.getElementById('adjustmentGrid').innerHTML    = '';
    document.getElementById('alignmentScore').textContent  = '0%';
    document.getElementById('pharynxScore').textContent    = '--';
    document.getElementById('formantsAligned').textContent = '0/4';
    ['alignment','pharynx','formants'].forEach(id =>
        document.getElementById(id + 'Bar').style.width = '0%'
    );
}

// ‚îÄ‚îÄ Draw loop ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function draw() {
    animationId = requestAnimationFrame(draw);
    analyser.getByteFrequencyData(dataArray);

    const maxCols = Math.floor(canvas.width / 2);
    if (spectrogramData.length > maxCols) spectrogramData.shift();
    spectrogramData.push([...dataArray]);

    ctx2d.fillStyle = '#000';
    ctx2d.fillRect(0, 0, canvas.width, canvas.height);

    const sliceW = canvas.width / spectrogramData.length;
    const bwHz   = (audioCtx.sampleRate / 2) / dataArray.length;
    const maxBin = Math.min(dataArray.length, Math.floor(6000 / bwHz));

    for (let i = 0; i < spectrogramData.length; i++) {
        const slice = spectrogramData[i];
        for (let j = 0; j < maxBin; j++) {
            const p = slice[j] / 255;
            let r, g, b;
            if      (p < 0.3) { r = 0;                        g = Math.floor(p*850);      b = 255; }
            else if (p < 0.7) { r = Math.floor((p-0.3)*637);  g = 255;                    b = Math.floor((0.7-p)*637); }
            else               { r = 255;                       g = Math.floor((1-p)*850);  b = 0; }
            ctx2d.fillStyle = `rgb(${r},${g},${b})`;
            const y = canvas.height - (j / maxBin) * canvas.height;
            ctx2d.fillRect(i * sliceW, y, sliceW + 0.5, canvas.height / maxBin + 0.5);
        }
    }

    coachingAnalysis(dataArray);
}

// ‚îÄ‚îÄ Analysis ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function coachingAnalysis(fd) {
    const nyquist = audioCtx.sampleRate / 2;
    const bw      = nyquist / fd.length;
    const f0      = detectFundamental(fd, bw);
    const cs      = document.getElementById('coachStatus');

    if (f0 < 50 || f0 > 1200) {
        cs.textContent = `üé§ Waiting... sustain "${selectedSound.symbol}" clearly`;
        cs.className   = 'coach-status waiting';
        return;
    }

    cs.textContent = `üéµ Analysing "${selectedSound.symbol}" at ${Math.round(f0)} Hz...`;
    cs.className   = 'coach-status analyzing';

    const formants   = detectFormants(fd, bw);
    const harmonics  = detectHarmonics(f0, fd, bw);
    const alignments = calculateAlignment(formants, harmonics);
    const metrics    = calculateMetrics(fd, bw, f0, formants, alignments);

    generateCoaching(formants, metrics);
    updateProgress(metrics, formants);
}

function detectFundamental(fd, bw) {
    let maxVal = 0, maxBin = 0;
    const lo = Math.floor(60  / bw);
    const hi = Math.floor(600 / bw);
    for (let i = lo; i < hi && i < fd.length; i++) {
        if (fd[i] > maxVal) { maxVal = fd[i]; maxBin = i; }
    }
    return maxVal < 50 ? 0 : maxBin * bw;
}

function detectHarmonics(f0, fd, bw) {
    const out = [];
    for (let h = 1; h <= 15; h++) {
        const freq = f0 * h;
        if (freq > 6000) break;
        const bin = Math.round(freq / bw);
        if (bin >= fd.length) break;
        if (fd[bin] > 25) out.push({ number: h, frequency: freq, amplitude: fd[bin] });
    }
    return out;
}

function detectFormants(fd, bw) {
    const sm = smoothSpectrum(fd);
    return [
        { name: 'f1', min:  150, max: 1000 },
        { name: 'f2', min:  800, max: 2800 },
        { name: 'f3', min: 1800, max: 3800 },
        { name: 'f4', min: 2800, max: 5000 }
    ].reduce((acc, r) => {
        const pk = findPeak(sm, bw, r.min, r.max);
        if (pk.frequency > 0 && pk.amplitude > 35)
            acc.push({ name: r.name, frequency: pk.frequency, amplitude: pk.amplitude });
        return acc;
    }, []);
}

function smoothSpectrum(data) {
    const out = new Uint8Array(data.length);
    for (let i = 0; i < data.length; i++) {
        let sum = 0, n = 0;
        for (let j = -5; j <= 5; j++) {
            const k = i + j;
            if (k >= 0 && k < data.length) { sum += data[k]; n++; }
        }
        out[i] = Math.round(sum / n);
    }
    return out;
}

function findPeak(data, bw, minF, maxF) {
    const lo = Math.floor(minF / bw);
    const hi = Math.floor(maxF / bw);
    let peakVal = 0, peakBin = 0;
    for (let i = lo; i <= hi && i < data.length; i++) {
        if (data[i] > peakVal) { peakVal = data[i]; peakBin = i; }
    }
    return { frequency: peakBin * bw, amplitude: peakVal };
}

function calculateAlignment(formants, harmonics) {
    return harmonics.map(h => {
        let best = null, bestDist = Infinity;
        formants.forEach(f => {
            const d = Math.abs(f.frequency - h.frequency);
            if ((d / h.frequency) * 100 < 20 && d < bestDist) { bestDist = d; best = f; }
        });
        const pct    = best ? (bestDist / h.frequency) * 100 : 100;
        const status = pct <= 5 ? 'perfect' : pct <= 10 ? 'good' : pct <= 20 ? 'near' : 'none';
        return { harmonic: h, formant: best, distance: bestDist, percentDiff: pct, status };
    });
}

function calculateMetrics(fd, bw, f0, formants, alignments) {
    const low  = energy(fd, bw,   60,  500);
    const high = energy(fd, bw, 2000, 5000);
    let alignmentScore = 0;
    alignments.forEach(a => {
        if      (a.status === 'perfect') alignmentScore += 10;
        else if (a.status === 'good')    alignmentScore += 6;
        else if (a.status === 'near')    alignmentScore += 3;
    });
    return {
        pharynxScore:     Math.min(100, (low / 255) * 150),
        alignmentScore:   Math.min(100, alignmentScore),
        formantsDetected: formants.length,
        alignedCount:     alignments.filter(a => a.status === 'perfect' || a.status === 'good').length,
        highEnergy:       high, lowEnergy: low
    };
}

function energy(fd, bw, minF, maxF) {
    const lo = Math.floor(minF / bw), hi = Math.floor(maxF / bw);
    let sum = 0, n = 0;
    for (let i = lo; i <= hi && i < fd.length; i++) { sum += fd[i]; n++; }
    return n > 0 ? sum / n : 0;
}

// ‚îÄ‚îÄ Coaching cards ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function generateCoaching(formants, metrics) {
    const grid = document.getElementById('adjustmentGrid');
    const cs   = document.getElementById('coachStatus');
    const s    = selectedSound;

    // ‚îÄ‚îÄ Check each formant against target ranges ‚îÄ‚îÄ
    const formantResults = ['f1','f2','f3','f4'].map(fn => {
        const target = s[fn];
        const detected = formants.find(f => f.name === fn);
        if (!target || target[0] === null) return { name: fn, skip: true };

        if (!detected) return {
            name: fn, detected: null,
            status: 'missing',
            low: target[0], high: target[1]
        };

        const inRange = detected.frequency >= target[0] && detected.frequency <= target[1];
        const tooLow  = detected.frequency < target[0];
        return {
            name: fn,
            detected: detected.frequency,
            status: inRange ? 'good' : (tooLow ? 'too-low' : 'too-high'),
            low: target[0], high: target[1]
        };
    }).filter(r => !r.skip);

    const goodCount = formantResults.filter(r => r.status === 'good').length;
    const total     = formantResults.length;

    // ‚îÄ‚îÄ Build cards ‚îÄ‚îÄ
    const adjs = [];

    // Card 1: Pharynx / Throat
    if (metrics.pharynxScore < 50) {
        adjs.push({ area:'Pharynx', icon:'üó£Ô∏è', status:'critical', cardClass:'warning',
            instruction:'OPEN YOUR THROAT MORE! Drop jaw, think "yawn". Tongue root forward, not pulled back.',
            statusText:`‚ùå ${Math.round(metrics.pharynxScore)}% open` });
    } else if (metrics.pharynxScore < 70) {
        adjs.push({ area:'Pharynx', icon:'üó£Ô∏è', status:'needs-work', cardClass:'',
            instruction:'Open throat a bit more. Maintain that yawn feeling.',
            statusText:`‚ö†Ô∏è ${Math.round(metrics.pharynxScore)}% open` });
    } else {
        adjs.push({ area:'Pharynx', icon:'üó£Ô∏è', status:'good', cardClass:'active',
            instruction:'Great throat openness! Maintain this resonant space.',
            statusText:`‚úÖ ${Math.round(metrics.pharynxScore)}% open` });
    }

    // Card 2: Tongue ‚Äî sound-specific
    const badFormant = formantResults.find(r => r.status !== 'good');
    if (badFormant && badFormant.status === 'missing') {
        adjs.push({ area:'Tongue', icon:'üëÖ', status:'critical', cardClass:'warning',
            instruction: s.coachTongue + ' Formant not detected ‚Äî check your position.',
            statusText:`‚ùå ${badFormant.name.toUpperCase()} missing` });
    } else if (badFormant && badFormant.status === 'too-low') {
        adjs.push({ area:'Tongue', icon:'üëÖ', status:'needs-work', cardClass:'',
            instruction:`${badFormant.name.toUpperCase()} too low (${Math.round(badFormant.detected)}Hz, target ${badFormant.low}‚Äì${badFormant.high}Hz). ${s.coachTongue}`,
            statusText:`‚ö†Ô∏è ${badFormant.name.toUpperCase()} too low` });
    } else if (badFormant && badFormant.status === 'too-high') {
        adjs.push({ area:'Tongue', icon:'üëÖ', status:'needs-work', cardClass:'',
            instruction:`${badFormant.name.toUpperCase()} too high (${Math.round(badFormant.detected)}Hz, target ${badFormant.low}‚Äì${badFormant.high}Hz). Relax and lower tongue slightly.`,
            statusText:`‚ö†Ô∏è ${badFormant.name.toUpperCase()} too high` });
    } else {
        const f1d = formants.find(f => f.name === 'f1');
        const f2d = formants.find(f => f.name === 'f2');
        adjs.push({ area:'Tongue', icon:'üëÖ', status:'good', cardClass:'active',
            instruction:`Perfect! ${s.coachTongue}`,
            statusText:`‚úÖ ${f1d ? 'F1:'+Math.round(f1d.frequency)+'Hz' : ''} ${f2d ? 'F2:'+Math.round(f2d.frequency)+'Hz' : ''}` });
    }

    // Card 3: Lips ‚Äî sound-specific
    if (metrics.highEnergy < 40 && s.lips !== 'neutral') {
        adjs.push({ area:'Lips', icon:'üíã', status:'critical', cardClass:'warning',
            instruction:`ADJUST LIPS! For "${s.symbol}": ${s.coachLips}`,
            statusText:'‚ùå Lip resonance weak' });
    } else if (goodCount === total) {
        adjs.push({ area:'Lips', icon:'üíã', status:'good', cardClass:'active',
            instruction:`Great lip position for "${s.symbol}"! ${s.coachLips}`,
            statusText:'‚úÖ All formants in range' });
    } else {
        adjs.push({ area:'Lips', icon:'üíã', status:'needs-work', cardClass:'',
            instruction:`For "${s.symbol}": ${s.coachLips}`,
            statusText:`‚ö†Ô∏è ${goodCount}/${total} formants in range` });
    }

    // Overall status
    cs.textContent = metrics.alignmentScore < 40
        ? `üî¥ Keep adjusting your "${s.symbol}" ‚Äî follow red cards`
        : metrics.alignmentScore < 70
        ? `üü° Getting closer on "${s.symbol}" ‚Äî fine tune!`
        : `üü¢ Excellent "${s.symbol}"! All targets met!`;
    cs.className = 'coach-status coaching';

    grid.innerHTML = adjs.map(a => `
        <div class="adjustment-card ${a.cardClass}">
            <div class="adjustment-title">
                <span class="adjustment-icon">${a.icon}</span>
                <span>${a.area}</span>
            </div>
            <div class="adjustment-instruction">${a.instruction}</div>
            <div class="adjustment-status status-${a.status}">${a.statusText}</div>
        </div>`).join('');
}

function updateProgress(metrics, formants) {
    document.getElementById('alignmentScore').textContent  = Math.round(metrics.alignmentScore) + '%';
    document.getElementById('alignmentBar').style.width    = metrics.alignmentScore + '%';
    document.getElementById('pharynxScore').textContent    = Math.round(metrics.pharynxScore) + '%';
    document.getElementById('pharynxBar').style.width      = metrics.pharynxScore + '%';
    document.getElementById('formantsAligned').textContent = `${metrics.alignedCount}/${metrics.formantsDetected}`;
    const pct = metrics.formantsDetected > 0 ? (metrics.alignedCount / metrics.formantsDetected) * 100 : 0;
    document.getElementById('formantsBar').style.width = pct + '%';
}

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
renderGrid();
updateCurrentSoundDisplay();
updateTargetFormantsDisplay();
</script>
</body>
</html>
